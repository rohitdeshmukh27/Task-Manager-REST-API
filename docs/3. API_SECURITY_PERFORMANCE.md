# ğŸ›¡ï¸ API Security & Performance - Complete Implementation Guide

## ğŸ“‹ Level 1: Quick Wins for Production-Ready API

Add **essential security and performance** improvements to your Task Manager API:

- **Helmet** - Security headers protection
- **Rate Limiting** - Prevent brute-force attacks
- **Compression** - Faster API responses
- **Morgan Logger** - Request logging & debugging

**Time to Complete:** 1-2 hours

---

# ğŸ¯ Why These Matter?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY THREATS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  âŒ WITHOUT PROTECTION:                                         â”‚
â”‚                                                                  â”‚
â”‚  â€¢ XSS attacks through headers                                  â”‚
â”‚  â€¢ Clickjacking vulnerabilities                                 â”‚
â”‚  â€¢ MIME type sniffing attacks                                   â”‚
â”‚  â€¢ Brute force login attempts (1000s/second)                    â”‚
â”‚  â€¢ DDoS attacks overwhelming your server                        â”‚
â”‚  â€¢ Slow responses = poor user experience                        â”‚
â”‚                                                                  â”‚
â”‚  âœ… WITH PROTECTION:                                            â”‚
â”‚                                                                  â”‚
â”‚  â€¢ Helmet sets 15+ security headers automatically               â”‚
â”‚  â€¢ Rate limiter blocks after X requests/window                  â”‚
â”‚  â€¢ Compression reduces payload size by 70%+                     â”‚
â”‚  â€¢ Logger helps debug issues in production                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ—ï¸ Updated Architecture

```
task-manager-api/
â”‚
â”œâ”€â”€ ğŸ“ src/
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ config/
â”‚   â”‚   â”œâ”€â”€ supabase.ts              # Supabase client (EXISTING)
â”‚   â”‚   â””â”€â”€ rateLimiter.ts           # [NEW] Rate limiting config
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ middleware/
â”‚   â”‚   â”œâ”€â”€ errorHandler.ts          # Error handling (EXISTING)
â”‚   â”‚   â”œâ”€â”€ authMiddleware.ts        # JWT verification (EXISTING)
â”‚   â”‚   â”œâ”€â”€ validateTask.ts          # Task validation (EXISTING)
â”‚   â”‚   â”œâ”€â”€ validateAuth.ts          # Auth validation (EXISTING)
â”‚   â”‚   â””â”€â”€ security.ts              # [NEW] Security middleware
â”‚   â”‚
â”‚   â””â”€â”€ app.ts                       # Entry point (MODIFY)
â”‚
â”œâ”€â”€ .env                             # Add new variables
â””â”€â”€ package.json                     # Add new dependencies
```

---

# ğŸ› ï¸ STEP-BY-STEP IMPLEMENTATION

---

## PHASE 1: INSTALL DEPENDENCIES

---

### STEP 1: Install Security & Performance Packages

```bash
# Install all packages at once
npm install helmet express-rate-limit compression morgan

# Install TypeScript types
npm install -D @types/compression @types/morgan
```

### Package Explanation:

| Package              | Purpose                        | Size  |
| -------------------- | ------------------------------ | ----- |
| `helmet`             | Sets security HTTP headers     | ~30KB |
| `express-rate-limit` | Rate limiting middleware       | ~20KB |
| `compression`        | Gzip compression for responses | ~25KB |
| `morgan`             | HTTP request logger            | ~15KB |

---

## PHASE 2: IMPLEMENT HELMET (Security Headers)

---

### STEP 2: Understanding Helmet

Helmet sets these security headers automatically:

| Header                      | Protection Against                     |
| --------------------------- | -------------------------------------- |
| `X-Content-Type-Options`    | MIME type sniffing                     |
| `X-Frame-Options`           | Clickjacking attacks                   |
| `X-XSS-Protection`          | Cross-site scripting (legacy browsers) |
| `Strict-Transport-Security` | Forces HTTPS connections               |
| `Content-Security-Policy`   | XSS and injection attacks              |
| `X-DNS-Prefetch-Control`    | DNS prefetching privacy                |
| `X-Download-Options`        | IE download execution                  |
| `X-Permitted-Cross-Domain`  | Adobe Flash/PDF cross-domain           |
| `Referrer-Policy`           | Referrer information leakage           |

---

### STEP 3: Create Security Middleware File

ğŸ“ **File:** `src/middleware/security.ts`

```typescript
// ============================================
// SECURITY MIDDLEWARE - Protection Layer
// ============================================

import helmet from "helmet";
import compression from "compression";
import morgan from "morgan";
import { Application, Request, Response } from "express";

/**
 * Configure Helmet security headers
 *
 * Helmet helps secure Express apps by setting HTTP response headers.
 */
export const configureHelmet = () => {
  return helmet({
    // Content Security Policy
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"], // Only allow resources from same origin
        scriptSrc: ["'self'"], // Only allow scripts from same origin
        styleSrc: ["'self'", "'unsafe-inline'"], // Allow inline styles (for error pages)
        imgSrc: ["'self'", "data:", "https:"], // Allow images from self, data URIs, HTTPS
        connectSrc: ["'self'"], // Only allow connections to same origin
        fontSrc: ["'self'"], // Only allow fonts from same origin
        objectSrc: ["'none'"], // Disallow plugins (Flash, etc.)
        mediaSrc: ["'self'"], // Only allow media from same origin
        frameSrc: ["'none'"], // Disallow iframes
      },
    },

    // Prevent clickjacking
    frameguard: {
      action: "deny", // Completely deny framing
    },

    // Hide X-Powered-By header (don't reveal Express)
    hidePoweredBy: true,

    // HTTP Strict Transport Security
    hsts: {
      maxAge: 31536000, // 1 year in seconds
      includeSubDomains: true, // Apply to subdomains
      preload: true, // Allow browser preloading
    },

    // Prevent IE from executing downloads in site's context
    ieNoOpen: true,

    // Prevent MIME type sniffing
    noSniff: true,

    // Control referrer information
    referrerPolicy: {
      policy: "strict-origin-when-cross-origin",
    },

    // XSS filter (legacy, but still useful)
    xssFilter: true,
  });
};

/**
 * Configure compression middleware
 *
 * Compresses response bodies for all requests.
 * Can reduce payload size by 70%+ for text-based responses.
 */
export const configureCompression = () => {
  return compression({
    // Compression level (1-9, higher = more compression but slower)
    level: 6,

    // Minimum size to compress (in bytes)
    threshold: 1024, // Don't compress responses smaller than 1KB

    // Filter function to determine if response should be compressed
    filter: (req: Request, res: Response) => {
      // Don't compress if client doesn't accept it
      if (req.headers["x-no-compression"]) {
        return false;
      }

      // Use compression's default filter
      return compression.filter(req, res);
    },
  });
};

/**
 * Configure Morgan request logger
 *
 * Logs all HTTP requests with useful information.
 */
export const configureMorgan = () => {
  // Use different formats based on environment
  const format =
    process.env.NODE_ENV === "production"
      ? "combined" // Apache combined log format (for production)
      : "dev"; // Colored, concise output (for development)

  return morgan(format, {
    // Skip logging for successful requests in production (optional)
    skip: (req: Request, res: Response) => {
      if (process.env.NODE_ENV === "production") {
        return res.statusCode < 400; // Only log errors in production
      }
      return false; // Log everything in development
    },
  });
};

/**
 * Custom Morgan format for detailed logging
 * Use this if you want more control over log format
 */
export const configureMorganCustom = () => {
  // Define custom tokens
  morgan.token("user-id", (req: Request) => {
    return (req as any).user?.id || "anonymous";
  });

  morgan.token("body", (req: Request) => {
    // Don't log sensitive data
    const safeBody = { ...req.body };
    if (safeBody.password) safeBody.password = "[REDACTED]";
    if (safeBody.refresh_token) safeBody.refresh_token = "[REDACTED]";
    return JSON.stringify(safeBody);
  });

  // Custom format string
  const customFormat =
    ":method :url :status :response-time ms - :user-id - :body";

  return morgan(customFormat);
};

/**
 * Apply all security middleware to Express app
 * Call this function in app.ts
 */
export const applySecurityMiddleware = (app: Application): void => {
  // 1. Helmet (security headers) - FIRST
  app.use(configureHelmet());

  // 2. Compression - EARLY (before routes)
  app.use(configureCompression());

  // 3. Morgan logger - EARLY (to log all requests)
  app.use(configureMorgan());

  console.log("âœ… Security middleware applied (Helmet, Compression, Morgan)");
};
```

### ğŸ’¡ Key Concepts:

- **Helmet** should be applied FIRST to set security headers
- **Compression** should be EARLY in middleware chain
- **Morgan** logs requests as they come in
- Order matters for middleware!

---

## PHASE 3: IMPLEMENT RATE LIMITING

---

### STEP 4: Understanding Rate Limiting

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RATE LIMITING FLOW                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Request #1 â”€â”€â–º [Counter: 1/100] â”€â”€â–º âœ… Allowed                â”‚
â”‚   Request #2 â”€â”€â–º [Counter: 2/100] â”€â”€â–º âœ… Allowed                â”‚
â”‚   ...                                                            â”‚
â”‚   Request #100 â”€â–º [Counter: 100/100] â–º âœ… Allowed               â”‚
â”‚   Request #101 â”€â–º [Counter: 101/100] â–º âŒ BLOCKED (429 Error)   â”‚
â”‚                                                                  â”‚
â”‚   [After 15 minutes, counter resets to 0]                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Different Limits for Different Routes:

| Route Type         | Limit        | Window | Why?                  |
| ------------------ | ------------ | ------ | --------------------- |
| **General API**    | 100 requests | 15 min | Normal usage          |
| **Auth (Login)**   | 5 requests   | 15 min | Prevent brute force   |
| **Auth (Signup)**  | 3 requests   | 1 hour | Prevent spam accounts |
| **Password Reset** | 3 requests   | 1 hour | Prevent email spam    |

---

### STEP 5: Create Rate Limiter Configuration

ğŸ“ **File:** `src/config/rateLimiter.ts`

```typescript
// ============================================
// RATE LIMITER CONFIGURATION
// ============================================

import rateLimit, { RateLimitRequestHandler } from "express-rate-limit";
import { Request, Response } from "express";

/**
 * General API rate limiter
 * Applies to all routes by default
 *
 * 100 requests per 15 minutes per IP
 */
export const generalLimiter: RateLimitRequestHandler = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes in milliseconds
  max: 100, // Limit each IP to 100 requests per window

  // Response when limit is exceeded
  message: {
    success: false,
    message: "Too many requests, please try again later.",
    error: "Rate limit exceeded. Please wait 15 minutes.",
    retryAfter: "15 minutes",
  },

  // HTTP status code when limit exceeded
  statusCode: 429,

  // Headers to send with rate limit info
  standardHeaders: true, // Return rate limit info in `RateLimit-*` headers
  legacyHeaders: false, // Disable `X-RateLimit-*` headers (deprecated)

  // Skip rate limiting for certain requests (optional)
  skip: (req: Request) => {
    // Skip rate limiting for health check endpoint
    if (req.path === "/" || req.path === "/health") {
      return true;
    }
    return false;
  },

  // Custom key generator (default is IP address)
  keyGenerator: (req: Request) => {
    // Use X-Forwarded-For header if behind proxy, otherwise use IP
    return (
      req.ip ||
      req.headers["x-forwarded-for"]?.toString() ||
      req.socket.remoteAddress ||
      "unknown"
    );
  },

  // Handler when rate limit is exceeded
  handler: (req: Request, res: Response) => {
    console.warn(`âš ï¸ Rate limit exceeded for IP: ${req.ip} on ${req.path}`);

    res.status(429).json({
      success: false,
      message: "Too many requests, please try again later.",
      error:
        "You have exceeded the rate limit. Please wait before making more requests.",
      retryAfter: res.getHeader("Retry-After"),
    });
  },
});

/**
 * Strict rate limiter for authentication endpoints
 * Prevents brute force attacks on login
 *
 * 5 requests per 15 minutes per IP
 */
export const authLimiter: RateLimitRequestHandler = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 5, // Only 5 attempts

  message: {
    success: false,
    message: "Too many login attempts, please try again later.",
    error: "Account temporarily locked due to multiple failed attempts.",
    retryAfter: "15 minutes",
  },

  statusCode: 429,
  standardHeaders: true,
  legacyHeaders: false,

  // Skip successful requests (only count failed attempts)
  skipSuccessfulRequests: false,

  handler: (req: Request, res: Response) => {
    console.warn(`ğŸ” Auth rate limit exceeded for IP: ${req.ip}`);

    res.status(429).json({
      success: false,
      message: "Too many authentication attempts.",
      error: "Please wait 15 minutes before trying again.",
      retryAfter: res.getHeader("Retry-After"),
    });
  },
});

/**
 * Very strict limiter for signup
 * Prevents mass account creation
 *
 * 3 requests per hour per IP
 */
export const signupLimiter: RateLimitRequestHandler = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 3, // Only 3 signups per hour

  message: {
    success: false,
    message: "Too many accounts created, please try again later.",
    error: "Signup limit reached. Please wait 1 hour.",
    retryAfter: "1 hour",
  },

  statusCode: 429,
  standardHeaders: true,
  legacyHeaders: false,

  handler: (req: Request, res: Response) => {
    console.warn(`ğŸ“ Signup rate limit exceeded for IP: ${req.ip}`);

    res.status(429).json({
      success: false,
      message: "Too many signup attempts.",
      error: "Please wait 1 hour before creating another account.",
      retryAfter: res.getHeader("Retry-After"),
    });
  },
});

/**
 * Password reset limiter
 * Prevents email spam
 *
 * 3 requests per hour per IP
 */
export const passwordResetLimiter: RateLimitRequestHandler = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 3, // Only 3 reset requests per hour

  message: {
    success: false,
    message: "Too many password reset requests.",
    error: "Please check your email or wait 1 hour.",
    retryAfter: "1 hour",
  },

  statusCode: 429,
  standardHeaders: true,
  legacyHeaders: false,
});

/**
 * Create task limiter
 * Prevents spam task creation
 *
 * 30 tasks per hour per IP
 */
export const createTaskLimiter: RateLimitRequestHandler = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 30, // 30 tasks per hour

  message: {
    success: false,
    message: "Task creation limit reached.",
    error: "You can create up to 30 tasks per hour.",
    retryAfter: "1 hour",
  },

  statusCode: 429,
  standardHeaders: true,
  legacyHeaders: false,
});
```

### ğŸ’¡ Rate Limiting Best Practices:

1. **Different limits for different routes** - Auth needs stricter limits
2. **Log rate limit violations** - Helps detect attacks
3. **Use standard headers** - Clients can see remaining requests
4. **Consider user ID** - For logged-in users, limit by user ID not IP

---

## PHASE 4: UPDATE APP.TS

---

### STEP 6: Integrate All Security Middleware

ğŸ“ **File:** `src/app.ts` (Updated)

```typescript
// ============================================
// EXPRESS APPLICATION - Main ENTRY POINT
// ============================================

import express, { Application, Request, Response } from "express";
import dotenv from "dotenv";

// Route imports
import taskRoutes from "./routes/taskRoutes";
import authRoutes from "./routes/authRoutes";

// Middleware imports
import { errorHandler, notFoundHandler } from "./middleware/errorHandler";
import { applySecurityMiddleware } from "./middleware/security";
import { generalLimiter } from "./config/rateLimiter";

// Load environment variables FIRST
dotenv.config();

// Create Express application
const app: Application = express();

// Port configuration
const PORT: number = parseInt(process.env.PORT || "3000", 10);
const NODE_ENV: string = process.env.NODE_ENV || "development";

// ============================================
// SECURITY MIDDLEWARE (Apply FIRST)
// ============================================

// Apply Helmet, Compression, and Morgan
applySecurityMiddleware(app);

// Apply general rate limiter to all requests
app.use(generalLimiter);

// ===========================
// BODY PARSING MIDDLEWARE
// ===========================

app.use(express.json({ limit: "10kb" })); // Limit body size for security
app.use(express.urlencoded({ extended: true }));

// ===========================
// CORS HEADERS
// ===========================

app.use((req: Request, res: Response, next) => {
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader(
    "Access-Control-Allow-Methods",
    "GET, POST, PUT, DELETE, OPTIONS",
  );
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");

  if (req.method === "OPTIONS") {
    res.sendStatus(200);
    return;
  }
  next();
});

// ==================
// ROUTES
// ==================

// Health Check (no rate limit applied via skip)
app.get("/", (req: Request, res: Response) => {
  res.status(200).json({
    success: true,
    message: "ğŸš€ Task Manager API is running!",
    version: "1.0.0",
    environment: NODE_ENV,
    documentation: "/api",
  });
});

// API documentation
app.get("/api", (req: Request, res: Response) => {
  res.status(200).json({
    success: true,
    message: "Task Manager API Documentation",
    version: "1.0.0",
    database: "Supabase (PostgreSQL)",
    security: {
      helmet: "Enabled (15+ security headers)",
      rateLimit: "100 requests per 15 minutes",
      compression: "Enabled (gzip)",
    },
    endpoints: [
      { method: "GET", path: "/api/tasks", description: "Get all tasks" },
      {
        method: "GET",
        path: "/api/tasks/stats",
        description: "Get task statistics",
      },
      { method: "GET", path: "/api/tasks/:id", description: "Get task by ID" },
      {
        method: "POST",
        path: "/api/tasks",
        description: "Create new task (Auth required)",
      },
      {
        method: "PUT",
        path: "/api/tasks/:id",
        description: "Update task (Auth required)",
      },
      {
        method: "DELETE",
        path: "/api/tasks/:id",
        description: "Delete task (Auth required)",
      },
    ],
    authEndpoints: [
      {
        method: "POST",
        path: "/api/auth/signup",
        description: "Register new user",
        rateLimit: "3/hour",
      },
      {
        method: "POST",
        path: "/api/auth/login",
        description: "Login user",
        rateLimit: "5/15min",
      },
      {
        method: "POST",
        path: "/api/auth/logout",
        description: "Logout user (Auth required)",
      },
      {
        method: "POST",
        path: "/api/auth/forgot-password",
        description: "Request password reset",
        rateLimit: "3/hour",
      },
      {
        method: "POST",
        path: "/api/auth/reset-password",
        description: "Set new password (Auth required)",
      },
      {
        method: "GET",
        path: "/api/auth/me",
        description: "Get current user (Auth required)",
      },
      {
        method: "POST",
        path: "/api/auth/refresh",
        description: "Refresh access token",
      },
      {
        method: "POST",
        path: "/api/auth/resend-verification",
        description: "Resend verification email",
      },
    ],
  });
});

// Mount auth routes
app.use("/api/auth", authRoutes);

// Mount task routes
app.use("/api/tasks", taskRoutes);

// ============================================
// ERROR HANDLING
// ============================================

app.use(notFoundHandler);
app.use(errorHandler);

// ============================================
// START SERVER
// ============================================

app.listen(PORT, () => {
  console.log("");
  console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  console.log("â•‘  ğŸš€ Task Manager API Server Started!       â•‘");
  console.log("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
  console.log(`â•‘  ğŸ“ URL: http://localhost:${PORT}             â•‘`);
  console.log(`â•‘  ğŸ“š Docs: http://localhost:${PORT}/api          â•‘`);
  console.log(`â•‘  ğŸŒ Environment: ${NODE_ENV.padEnd(20)}  â•‘`);
  console.log("â•‘  ğŸ’¾ Database: Supabase PostgreSQL          â•‘");
  console.log("â•‘  ğŸ›¡ï¸  Security: Helmet + Rate Limiting       â•‘");
  console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
});

export default app;
```

---

## PHASE 5: UPDATE AUTH ROUTES WITH RATE LIMITING

---

### STEP 7: Apply Rate Limiters to Auth Routes

ğŸ“ **File:** `src/routes/authRoutes.ts` (Updated)

```typescript
// =============================
// AUTH ROUTES - API Endpoints
// =============================

import { Router } from "express";
import * as AuthController from "../controllers/authController";
import { authenticate } from "../middleware/authMiddleware";
import {
  validateSignup,
  validateLogin,
  validateForgotPassword,
  validateResetPassword,
} from "../middleware/validateAuth";
import {
  authLimiter,
  signupLimiter,
  passwordResetLimiter,
} from "../config/rateLimiter";

// Create router instance
const router = Router();

// ====================================
// PUBLIC ROUTES (No authentication required)
// ====================================

// POST /api/auth/signup
// Register new user - STRICT RATE LIMIT (3/hour)
router.post("/signup", signupLimiter, validateSignup, AuthController.signup);

// POST /api/auth/login
// Login existing user - STRICT RATE LIMIT (5/15min)
router.post("/login", authLimiter, validateLogin, AuthController.login);

// POST /api/auth/forgot-password
// Request password reset email - STRICT RATE LIMIT (3/hour)
router.post(
  "/forgot-password",
  passwordResetLimiter,
  validateForgotPassword,
  AuthController.forgotPassword,
);

// POST /api/auth/refresh
// Refresh access token - Uses general limiter
router.post("/refresh", AuthController.refreshToken);

// POST /api/auth/resend-verification
// Resend email verification - Uses general limiter
router.post("/resend-verification", AuthController.resendVerification);

// ====================================
// PROTECTED ROUTES (Authentication required)
// ====================================

// POST /api/auth/logout
router.post("/logout", authenticate, AuthController.logout);

// GET /api/auth/me
router.get("/me", authenticate, AuthController.getCurrentUser);

// POST /api/auth/reset-password
router.post(
  "/reset-password",
  authenticate,
  validateResetPassword,
  AuthController.resetPassword,
);

export default router;
```

---

## PHASE 6: UPDATE TASK ROUTES WITH RATE LIMITING

---

### STEP 8: Apply Rate Limiters to Task Routes

ğŸ“ **File:** `src/routes/taskRoutes.ts` (Updated)

```typescript
// =============================
// TASK ROUTES - API Endpoints
// =============================

import { Router } from "express";
import * as TaskController from "../controllers/taskController";
import {
  validateCreateTask,
  validateUpdateTask,
  validateTaskId,
  validateQueryParams,
} from "../middleware/validateTask";
import { authenticate } from "../middleware/authMiddleware";
import { createTaskLimiter } from "../config/rateLimiter";

// Create router instance
const router = Router();

// ====================================
// PUBLIC ROUTES (Read operations)
// ====================================

// GET /api/tasks/stats
// Get task statistics
router.get("/stats", TaskController.getTaskStats);

// GET /api/tasks
// Get all tasks (with optional filtering)
router.get("/", validateQueryParams, TaskController.getAllTasks);

// GET /api/tasks/:id
// Get task by ID
router.get("/:id", validateTaskId, TaskController.getTaskById);

// ====================================
// PROTECTED ROUTES (Write operations)
// ====================================

// POST /api/tasks
// Create new task (Protected + Rate Limited)
router.post(
  "/",
  authenticate,
  createTaskLimiter,
  validateCreateTask,
  TaskController.createTask,
);

// PUT /api/tasks/:id
// Update existing task (Protected)
router.put(
  "/:id",
  authenticate,
  validateTaskId,
  validateUpdateTask,
  TaskController.updateTask,
);

// DELETE /api/tasks/:id
// Delete task (Protected)
router.delete("/:id", authenticate, validateTaskId, TaskController.deleteTask);

export default router;
```

---

# ğŸ§ª TESTING SECURITY FEATURES

---

## Test 1: Check Security Headers

```bash
curl -I http://localhost:3000/api
```

**Expected Headers:**

```
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 0
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
Content-Security-Policy: default-src 'self'; ...
```

---

## Test 2: Check Rate Limiting

```bash
# Make 6 rapid login attempts (should be blocked on 6th)
for i in {1..6}; do
  curl -X POST http://localhost:3000/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"email":"test@test.com","password":"wrong"}'
  echo ""
done
```

**Expected:** 5 normal responses, then:

```json
{
  "success": false,
  "message": "Too many authentication attempts.",
  "error": "Please wait 15 minutes before trying again."
}
```

---

## Test 3: Check Compression

```bash
# Request with compression
curl -H "Accept-Encoding: gzip" http://localhost:3000/api/tasks -v
```

**Expected Header:**

```
Content-Encoding: gzip
```

---

## Test 4: Check Morgan Logging

When running the server, you should see logs like:

```
GET /api/tasks 200 45.123 ms - 1234
POST /api/auth/login 401 12.456 ms - 89
GET /api/tasks/123 404 5.789 ms - 56
```

---

# ğŸ“Š Security Checklist

| Feature                   | Status | Notes                         |
| ------------------------- | ------ | ----------------------------- |
| Helmet security headers   | âœ…     | 15+ headers automatically set |
| Rate limiting (general)   | âœ…     | 100 req/15min                 |
| Rate limiting (auth)      | âœ…     | 5 req/15min                   |
| Rate limiting (signup)    | âœ…     | 3 req/hour                    |
| Rate limiting (pwd reset) | âœ…     | 3 req/hour                    |
| Gzip compression          | âœ…     | 70%+ reduction                |
| Request logging           | âœ…     | Morgan with env-based format  |
| Body size limit           | âœ…     | 10KB limit                    |
| CORS headers              | âœ…     | Properly configured           |

---

# ğŸ‰ CONGRATULATIONS!

Your API now has:

- âœ… **15+ Security Headers** via Helmet
- âœ… **Brute Force Protection** via Rate Limiting
- âœ… **70%+ Smaller Responses** via Compression
- âœ… **Request Logging** via Morgan

**Next Steps:** Move on to the Code Quality Roadmap (Testing, Documentation, Linting)!
